fs = require 'fs'

module.exports = (robot) ->
  robot.router.post '/hubot/chatsecrets/:room', (req, res) ->
    room   = req.params.room


    if req?.files?.secret
      file = req.files.secret
      fs.readFile file.path, (err, data) ->
        if err?
          robot.emit 'error', err
          res.send 'FAIL'
          return

        robot.messageRoom room, "I have a secret: #{data}"
        res.send 'OK'
        fs.unlink(file.path)
    else if req.body?
      data = if req.body.payload?
        JSON.parse req.body.payload
      else
        req.body
      secret = data.secret
      robot.messageRoom room, "I have a secret: #{secret}"
      res.send 'OK'



